
{% extends "base.html" %}

{% block title %}Messages{% endblock %}

{% block content %}
<h1>Messaging System</h1>

<div class="messaging-container">
    <div class="user-list">
        <h2>Users</h2>
        <ul>
            {% for user in users %}
                {% if user != current_user %}
                    <li class="user-item" data-user-id="{{ user.id }}">{{ user.name }}</li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>
    <div class="chat-window">
        <div id="chat-messages"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Type your message..." required>
            <button type="submit">Send</button>
        </form>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    let currentRecipientId = null;

    function displayMessage(message) {
        const chatMessages = document.getElementById('chat-messages');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        messageElement.classList.add(message.sender_id === {{ current_user.id }} ? 'sent' : 'received');
        messageElement.textContent = message.content;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    document.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('click', function() {
            currentRecipientId = this.dataset.userId;
            document.getElementById('chat-messages').innerHTML = '';
            // Fetch previous messages
            fetch(`/get_messages/${currentRecipientId}`)
                .then(response => response.json())
                .then(messages => {
                    messages.forEach(displayMessage);
                });
        });
    });

    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (currentRecipientId) {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            if (message) {
                socket.emit('send_message', {recipient_id: currentRecipientId, content: message});
                messageInput.value = '';
            }
        } else {
            alert('Please select a user to message.');
        }
    });

    socket.on('new_message', function(message) {
        if (message.sender_id == currentRecipientId || message.recipient_id == currentRecipientId) {
            displayMessage(message);
        }
    });
</script>
{% endblock %}
